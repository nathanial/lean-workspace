{{#if hasImage}}
<img src="{{imageUrl}}" alt="Panel {{panelIndex}}" class="panel-image">
<div class="panel-overlay">
  <button class="btn regenerate-btn"
          onclick="this.closest('.panel').querySelector('.panel-prompt-form').style.display = 'block'; this.closest('.panel-overlay').style.display = 'none';">
    Regenerate
  </button>
</div>
<form method="POST" action="/novels/{{novelId}}/page/{{pageNumber}}/panel/{{panelIndex}}/caption" class="panel-caption-form">
  <input type="text" name="caption" value="{{caption}}" placeholder="Add caption..." class="panel-caption-input">
  <button type="submit" class="btn btn-small">Save</button>
</form>
<form method="POST" action="/novels/{{novelId}}/page/{{pageNumber}}/panel/{{panelIndex}}/generate"
      class="panel-prompt-form" style="display: none; position: absolute; inset: 0; background: rgba(13,13,13,0.95); padding: 2rem; z-index: 20;">
  <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
    <textarea name="prompt" placeholder="Describe this panel..." class="panel-prompt-input" style="max-width: 320px;">{{prompt}}</textarea>
    <div class="panel-prompt-actions">
      <button type="button" class="btn btn-small btn-secondary"
              onclick="this.closest('.panel-prompt-form').style.display = 'none'; this.closest('.panel').querySelector('.panel-overlay').style.display = 'flex';">
        Cancel
      </button>
      <button type="submit" class="btn btn-small btn-primary">Generate</button>
    </div>
  </div>
</form>
{{else if isGenerating}}
<div class="panel-generating" id="generating-{{panelIndex}}"
     data-status-url="/novels/{{novelId}}/page/{{pageNumber}}/panel/{{panelIndex}}/status">
  <div class="spinner"></div>
  <span>Generating...</span>
</div>
<script>
(function() {
  var el = document.getElementById('generating-{{panelIndex}}');
  if (!el) return;
  var url = el.dataset.statusUrl;
  var interval = setInterval(function() {
    fetch(url).then(function(r) { return r.text(); }).then(function(html) {
      el.outerHTML = html;
      if (html.indexOf('panel-generating') === -1) clearInterval(interval);
    }).catch(function() {
      clearInterval(interval);
    });
  }, 3000);
})();
</script>
{{else if isError}}
<div class="panel-error">
  <span class="error-icon">!</span>
  <p>Generation failed</p>
  <form method="POST" action="/novels/{{novelId}}/page/{{pageNumber}}/panel/{{panelIndex}}/generate"
        class="panel-prompt-form">
    <textarea name="prompt" placeholder="Describe this panel..." class="panel-prompt-input">{{prompt}}</textarea>
    <button type="submit" class="btn btn-small btn-primary">Retry</button>
  </form>
</div>
{{else}}
<div class="panel-empty">
  <form method="POST" action="/novels/{{novelId}}/page/{{pageNumber}}/panel/{{panelIndex}}/generate"
        class="panel-prompt-form">
    <textarea name="prompt" placeholder="Describe what happens in this panel..." class="panel-prompt-input"></textarea>
    <button type="submit" class="btn btn-small btn-primary">Generate</button>
  </form>
</div>
{{/if}}
